---
title: "Exercise 3"
---

```{r setup, include=F}
  knitr::opts_chunk$set(collapse = TRUE, echo = FALSE, message = FALSE,warning = FALSE,
  fig.width = 4, fig.height = 3, comment = "#>")
  library(ggplot2)
```

# {.tabset}

## Background on Fishery {.tabset}

<b>Arctic sardine (<i>Pseudosardina arctica</i>)</b>

<br>
![](C:/Users/barretttj/Desktop/Workshop/sardine.png){width=20%}
<br>

The Arctic sardine is a fictional small pelagic species with a mean generation time of 5 years. It is a schooling fish that forms predictable aggregations for feeding, overwintering, and spawning. Suppose the Arctic sardine stock is divided in multiple management units (MUs) for the purposes of assessment and management (Figure 1):
<br>
•	MU1 (West spawning component)
<br>
•	MU2 (East offshore spawning component)
<br>
•	MU3 (East nearshore spawning component)
<br>
Each MU has several spawning areas and there is mixing of Arctic Sardine among the MUs during annual feeding and overwintering migrations. It is assumed that Arctic Sardine exhibit spawning-area fidelity such that during the spawning season, the fish are separated by MU. Acoustic surveys conducted on the spawning grounds therefore represent a measure of spawning stock biomass for the specific MU.
<br>
<br>


<b> Table 1. Description of Management Units </b>
<br>
<table border="1" cellpadding="0" cellspacing="" width="100%">
  <tr>
    <th>Management Unit</th>
    <th>Details</th>
  </tr>
  <tr>
    <td>1 (West spawning component)</td>
    <td>Largest component by landings (~90% for the stock)<br>
        3 spawning areas<br>
        Acoustic surveys in the 3 spawning areas<br>
        Gear types: purse seine (~80% of catches) and gill net<br>
        Purse seiners target spawning aggregations and summer feeding aggregations<br> </td>
  </tr><br>
  <tr>
    <td>2 (East offshore spawning component)</td>
    <td>Gear types: purse seine only<br>
        Fishing activity is limited due to distance<br>
        Specific spawning locations are unknown<br></td>
  </tr><br>
    <tr>
    <td>3 (East nearshore spawning component)</td>
    <td>Gear types: gill net only<br>
        2 spawning areas<br>
        Acoustic surveys in the 3 spawning areas<br></td>
  </tr>
</table>
<br>
<br>
<br>


![](C:/Users/barretttj/Desktop/Workshop/2.png){width=100%}

<B>Figure 1. Map of the Arctic sardine management unit (MU) 1: the focus of this Exercise</B>
<br>
<i>Green polygons = known spawning areas and locations of acoustic surveys conducted during the spawning season </i>

## MU1 Figures {.tabset}

### Parameters-at-age and annual phi<sub>0</sub> and <i>h</i> {.tabset}

```{r}
ls <- readRDS("C:/Users/barretttj/Desktop/LRP_workshop/3_ls1.rda")
ls[[1]]
```
<br><B>Figure 1.1 Weight-at-age time series</B>
<br><br>

```{r}
ls[[2]]
```
<br><B>Figure 1.2 Maturity-at-age time series</B>
<br><br>

```{r}
ls[[3]]
```
<br><B>Figure 1.3 Vulnerability-at-age time series</B>
<br>
<i> Note: Selectivity is changing over time due to variable catch percentages by fleet (the 2 fleets have different selectivities) </i> 
<br><br>

```{r}
ls[[4]]
```
<br><B>Figure 1.4 Unfished spawning biomass per recruit (phi<sub>0</sub>) time series</B>
<br>
<i> Note: Calculated using annual weight-at-age, maturity-at-age, and vulnerability-at-age  </i> 
<br><br>

```{r}
ls[[5]]
```
<br><B>Figure 1.5 Steepness (<i>h</i>) time series</B>
<br>
<i> Note: Steepness is estimated from constant Beverton-Holt a=0.0560481 and annual phi0  </i> 
<br><br>

### Model estimated variables {.tabset}

```{r}
ls2 <- readRDS("C:/Users/barretttj/Desktop/LRP_workshop/3_ls2.rda")
ls2[[1]]
```
<br><B>Figure 2.1 Estimated stock recruitment pairs</B>
<br><br>


```{r}
ls2[[2]] + geom_function(fun=function(x) 0.03988293*x/(1+0.01525999*x))
```
<br><B>Figure 2.2 Estimated stock recruitment pairs with model estimated fit</B>
<br>
<i> Model estimated Beverton-Holt stock recruitment relationship, a = 0.03988293; b = 0.01525999, estimated from assumed <i>h</i> = 0.75 and mean phi<sub>0</sub> over the first 5 years of the time series</i>
<br><br>

```{r}
ls2[[3]]
```
<br><B>Figure 2.3 Historical recruitment time series</B>
<br><br>

```{r}
ls2[[4]]
```
<br><B>Figure 2.4 Historical SSB time series</B>
<br><br>

```{r}
ls2[[5]]
```
<br><B>Figure 2.5 Historical catch time series</B>
<br><br>

```{r}
ls2[[6]]
```
<br><B>Figure 2.6 Historical <i>F</i> time series</B>
<br><br>

```{r}
ls2[[7]]
```
<br><B>Figure 2.7 Historical SSB time series</B>
<br>
<i>Notes:</i><br>
<i> Model estimated SSB as black line </i>
<br> 
<i> green line = Virgin unfished SSB<sub>0</sub> estimated using mean phi0 over first 5 years </i>
<br> 
<i> red line = Dynamic SSB<sub>0</sub> estimated using annual recruitment deviations, annual maturity-at-age, annual weight-at-age </i>
<br> 
<i> purple line = Dynamic SSB<sub>0</sub> estimated using annual recruitment deviations, annual maturity-at-age, mean weight-at-age over first 5 years </i>
<br> 
<i> grey line = Dynamic SSB<sub>0</sub> estimated using annual recruitment deviations, annual weight-at-age, mean maturity-at-age over first 5 years  </i>
<br> 
<i> blue line = Dynamic SSB<sub>0</sub> estimated using annual recruitment deviations, mean maturity-at-age and mean weight-at-age over first 5 years</i>

```{r}
D <- read.csv("C:/Users/barretttj/Desktop/LRP_workshop/Exercise 2/ex2_data.csv")
 D$MA_Index <- NA
  D$MA_Index[D$Year%in%28:50] <- apply(cbind(D$Acoustic_Index[D$Year%in%28:50],
                                             D$Acoustic_Index[D$Year%in%27:49],
                                             D$Acoustic_Index[D$Year%in%26:48]),1,mean)

  #Add loess smoother (example span = 0.5)
  lsmooth <- loess(Acoustic_Index ~ Year,data=D,span=0.5)  
  D$lowess_Index <- NA
  D$lowess_Index[D$Year%in%26:50] <- predict(lsmooth)

ggplot(D[!is.na(D$Acoustic_Index),]) + geom_path(mapping=aes(y=Acoustic_Index,x=Year),size=1) + theme_classic() + labs(x="Year", y="Acoustic SSB (kt)") + expand_limits(y=0,x=50) +
  geom_path(data=D[!is.na(D$MA_Index),],mapping=aes(y=MA_Index,x=Year),color="red") +
  scale_x_continuous(limits = c(0,50), expand = c(0, 0)) +
  geom_path(data=D[!is.na(D$lowess_Index),],mapping=aes(y=lowess_Index,x=Year),color="blue") 
```
<br><B>Figure 2.8 Acoustic Index of SSB (years 26-50)</B>
<br>
<i>Notes:</i><br>
<i> Index is a relative index of SSB </i><br>
<i> Black line = Annual index </i><br>
<i> Red line = 3 year moving average </i><br>
<i> Blue line = loess smoother with span = 0.5 </i>
<br>

